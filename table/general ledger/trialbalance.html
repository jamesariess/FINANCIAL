<div class="table-section" id="invoiceTableSection">
    <h3>Account Ledger</h3>
    <form method="post" style="margin-bottom: 20px;">
        <label for="accountName">Filter by Account Name: </label>
        <select name="accountName" id="accountName" onchange="this.form.submit()">
            <option value="all" <?php echo $selectedAccountName === 'all' ? 'selected' : ''; ?>>All</option>
            <?php foreach ($accountNames as $name): ?>
                <option value="<?php echo htmlspecialchars($name); ?>" <?php echo $selectedAccountName === $name ? 'selected' : ''; ?>>
                    <?php echo htmlspecialchars($name); ?>
                </option>
            <?php endforeach; ?>
        </select>
    </form>
    <table id="employeesTable">
        <thead>
            <tr>
                <th>Date</th>
                <th>Account Name</th>
                <th>Debit</th>
                <th>Credit</th>
                <th>Balance</th>
            </tr>
        </thead>
        <tbody id="employeesTableBody">
            <?php if (!empty($journalDetails)): ?>
                <?php
                    $previousAccountId = null; 
                    $runningBalance = 0; 
                    $previousAccountName = null; 
                    $isLastRowOfGroup = false;
                ?>
                <?php foreach ($journalDetails as $index => $row): ?>
                    <?php
                        // Check if this is the last row of the current accountName group
                        $nextRow = isset($journalDetails[$index + 1]) ? $journalDetails[$index + 1] : null;
                        $isLastRowOfGroup = ($nextRow && $nextRow['accountName'] !== $row['accountName']) || !$nextRow;
                    ?>
                    <tr>
                        <td> <?php echo date('M d, Y', strtotime($row['date'])); ?></td>
                        <td>
                            <?php
                                // Display accountName only if it differs from the previous accountID or is the first row
                                if ($previousAccountId !== $row['accountID']) {
                                    echo htmlspecialchars($row['accountName']);
                                    $previousAccountId = $row['accountID'];
                                    $previousAccountName = $row['accountName']; // Reset previous account name
                                    $runningBalance = 0; // Reset running balance for a new accountID
                                } elseif ($previousAccountName !== $row['accountName']) {
                                    echo htmlspecialchars($row['accountName']);
                                    $previousAccountName = $row['accountName'];
                                }
                            ?>
                        </td>
                        <td style="color: green; font-weight: bold;">
                            <?php echo htmlspecialchars(number_format($row['debit'], 2)); ?>
                        </td>
                        <td style="color: red; font-weight: bold;">
                            <?php echo htmlspecialchars(number_format($row['credit'], 2)); ?>
                        </td>
                        <td>
                            <?php
                                // Calculate balance based on accountType and update running balance
                                $accountType = strtolower(trim($row['accounType']));
                                $currentChange = 0;
                                if (in_array($accountType, ['assets', 'expenses'])) {
                                    $currentChange = $row['debit'] - $row['credit']; // Debit increases, Credit decreases
                                } elseif (in_array($accountType, ['liabilities', 'equity', 'revenue', 'income'])) {
                                    $currentChange = $row['credit'] - $row['debit']; // Credit increases, Debit decreases
                                }
                                $runningBalance += $currentChange; // Update running balance
                                // Apply bold style to the last row of each accountName group
                                $style = $isLastRowOfGroup ? 'font-weight: bold;' : '';
                                echo "<span style='$style'>" . htmlspecialchars(number_format($runningBalance, 2)) . "</span>";
                            ?>
                        </td>
                    </tr>
                <?php endforeach; ?>
            <?php else: ?>
                <tr><td colspan="5" class="text-center p-4">No Records Found.</td></tr>
            <?php endif; ?>
        </tbody>
    </table>
</div>