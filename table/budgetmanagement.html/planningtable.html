<style>
    .status-badge {
        padding: 4px 12px;
        border-radius: 9999px; /* pill shape */
        font-size: 0.875rem;   /* text-sm */
        font-weight: 500;
        display: inline-block;
    }
    .status-paid {
        background-color: #dcfce7; 
        color: #166534;          
        border: 1px solid #86efac;
    }
    .status-approved {
        background-color: #dbeafe; 
        color: #1e40af;           
        border: 1px solid #93c5fd;
    }
    .status-reject {
        background-color: #fee2e2; 
        color: #991b1b;            
        border: 1px solid #fca5a5;
    }
    .status-verified {
        background-color: #ffedd5; 
        color: #9a3412;           
        border: 1px solid #fdba74;
    }
    .status-default {
        background-color: #e5e7eb; 
        color: #374151;
        border: 1px solid #d1d5db;
    }
</style>

<div class="table-section" id="disbursementTableSection">
    <h3>Approval Report</h3>
    <table id="employeesTable">
        <thead>
            <tr>
                <th>Approve ID</th>
                <th>Title</th>
                <th>Request Type</th>
                <th>Amount</th>
                <th>Approve Amount</th>
                <th>Request By</th>
                <th>Due Date</th>
                <th>Purpuse</th>
                <th>Status</th>
                <th>Date</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="employeesTableBody">
            <?php if(!empty($disbursementReports)):
            foreach($disbursementReports as $row): ?>
            <tr>
                <td><?php echo htmlspecialchars($row['requestID']);?></td>
                <td><?php echo htmlspecialchars($row['requestTiTle']);?></td>
                <td><?php echo htmlspecialchars($row['Title']);?></td>
                <td>
                  ‚Ç± <?php 
                 if (!empty($row['Amount'])) {
            echo number_format($row['Amount'], 0, ".", ","); 
                       } else {
            echo "0";
        }
                   ?>
              </td>
                             <td>
                  ‚Ç± <?php 
                 if (!empty($row['ApprovedAmount'])) {
            echo number_format($row['ApprovedAmount'], 0, ".", ","); 
                       } else {
            echo "0";
        }
                   ?>
              </td>
                <td><?php echo htmlspecialchars($row['Requested_by']);?></td>
                <td><?php if (!empty($row['Due'])) {
                        echo date("F j, Y", strtotime($row['Due']));} else {
                        echo "-";}?></td>
             <td><?php echo htmlspecialchars($row['Purpuse']);?></td>
        <td>
           
    <?php 
        $status = strtolower($row['status']);
        $statusClass = "status-default";

        switch ($status) {
            case "paid":
                $statusClass = "status-paid";
                break;
            case "approved":
                $statusClass = "status-approved";
                break;
            case "reject":
            case "rejected":
                $statusClass = "status-reject";
                break;
            case "pending":
                $statusClass = "status-verified";
                break;
        }
    ?>
    <span class="status-badge <?php echo $statusClass; ?>">
        <?php echo htmlspecialchars($row['status']); ?>
    </span>
</td>

                <td> <?php 
                    if (!empty($row['date'])) {
                        echo date("F j, Y g:i A", strtotime($row['date'])); 
                    } else {
                        echo "-";
                    }
                ?></td>
               <td>
    <a href="#"
       onclick="openViewModal(
           '<?php echo $row['requestID'];?>',
           '<?php echo htmlspecialchars($row['requestTiTle'], ENT_QUOTES);?>',
           '<?php echo htmlspecialchars($row['Title'], ENT_QUOTES);?>',
           '<?php echo htmlspecialchars($row['Amount'], ENT_QUOTES);?>',
           '<?php echo htmlspecialchars($row['Requested_by'], ENT_QUOTES);?>',
           '<?php echo htmlspecialchars($row['Due'], ENT_QUOTES);?>',
           '<?php echo htmlspecialchars($row['status'], ENT_QUOTES);?>',
           '<?php echo htmlspecialchars($row['Purpuse'], ENT_QUOTES);?>');
           return false;">
       üëÅÔ∏è View
    </a>

    <?php 
        $status = strtolower(trim($row['status']));  // normalize status

        // Hide update if status is "paid" or "released"
        if ($status !== 'paid' && $status !== 'released' && $status !== 'rejected') : ?>
            <a href="#"
               onclick="openUpdateModal(
                   '<?php echo $row['requestID'];?>',
                   '<?php echo htmlspecialchars($row['ApprovedAmount'], ENT_QUOTES);?>');
                   return false;">
               ‚úèÔ∏è Update
            </a>
    <?php endif; ?>
</td>
            </tr>
            <?php endforeach; else:?>
            <tr><td colspan="11" class="text-center p-4">NO Records Found.</td></tr>
            <?php endif;?>
        </tbody>
    </table>
</div>

<div id="viewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center" onclick="outsideClick(event, 'viewModal')">
    <div class="bg-white p-6 rounded-lg shadow-lg w-1/3 relative" onclick="event.stopPropagation()">
        <h2 class="text-lg font-bold mb-4">View Request</h2>
        <div class="space-y-2">
            <p><strong>Request ID:</strong> <span id="viewRequestId"></span></p>
            <p><strong>Title:</strong> <span id="viewTitle"></span></p>
            <p><strong>Request Type:</strong> <span id="viewModules"></span></p>
            <p><strong>Amount:</strong> <span id="viewAmount"></span></p>
            <p><strong>Requested By:</strong> <span id="viewRequestedBy"></span></p>
            <p><strong>Due Date:</strong> <span id="viewDue"></span></p>
            <p><strong>Status:</strong> <span id="viewStatus"></span></p>
           
         
            <p><strong>Purpuse:</strong> <span id="viewPurpuse"></span></p>
        </div>
         <button class="mt-4 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600" onclick="closeModal('viewModal')">Close</button>
    </div>
</div>


<div id="updateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center" onclick="outsideClick(event, 'updateModal')">
    <div class="bg-white p-6 rounded-lg shadow-lg w-1/3 relative" onclick="event.stopPropagation()">
        <button class="absolute top-2 right-2 text-gray-500 hover:text-black" onclick="closeModal('updateModal')">&times;</button>
        <h2 class="text-lg font-bold mb-4">Update Request</h2>
        <form method="post" action="">    
            <input type="hidden" name="update_request_id" id="updateRequestId">
            <div class="space-y-4 form-group">
                <div>
                    <label for="updateAmount" class="block text-gray-700">Approve Amount:</label>
                    <input type="number" name="update_amount" id="updateAmount" class="w-full p-2 border rounded" required>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button type="button" class="text-white px-4 py-2 bg-red-500 rounded-lg hover:bg-red-600" onclick="closeModal('updateModal')">Cancel</button>
                <button name="update" type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Update</button>
            </div>
        </form>
    </div>
</div>

<div id="rejectModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center" onclick="outsideClick(event, 'rejectModal')">
    <div class="bg-white p-6 rounded-lg shadow-lg w-1/3 relative" onclick="event.stopPropagation()">
        <button class="absolute top-2 right-2 text-gray-500 hover:text-black" onclick="closeModal('rejectModal')">&times;</button>
        <h2 class="text-lg font-bold mb-4">Reject Request</h2>
        <form id="rejectForm">    
            <input type="hidden" id="rejectRequestId">
            <div class="space-y-4 form-group">
                <div>
                    <label for="rejectRemarks" class="block text-gray-700">Remarks (optional):</label>
                    <textarea id="rejectRemarks" rows="3" class="w-full p-2 border rounded"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button type="button" class="text-white px-4 py-2 bg-blue-500 rounded-lg hover:bg-blue-600" onclick="closeModal('rejectModal')">Cancel</button>
                <button type="button" id="rejectBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Reject</button>
            </div>
        </form>
    </div>
</div>

<div id="approveModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center" onclick="outsideClick(event, 'approveModal')">
    <div class="bg-white p-6 rounded-lg shadow-lg w-1/3 relative" onclick="event.stopPropagation()">
        <button class="absolute top-2 right-2 text-gray-500 hover:text-black" onclick="closeModal('approveModal')">&times;</button>
        <h2 class="text-lg font-bold mb-4">Approve Request</h2>
        <input type="hidden" id="approveRequestId">
        <div class="space-y-4 form-group">
            <div>
                <p class="text-gray-700">Are you sure you want to approve this request with amount:</p>
                <p class="font-semibold text-lg text-blue-600" id="confirmAmount"></p>
            </div>
        </div>
        <div class="flex justify-end space-x-3 mt-4">
            <button type="button" class="text-white px-4 py-2 bg-blue-500 rounded-lg hover:bg-blue-600" onclick="closeModal('approveModal')">Cancel</button>
            <button type="button" id="approveConfirmBtn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Confirm Approve</button>
        </div>
    </div>
</div>

<script>

      function openViewModal(requestID, title, modules, amount, requestedBy, due, status, purpuse) {
        document.getElementById('viewRequestId').innerText = requestID;
        document.getElementById('viewTitle').innerText = title;
        document.getElementById('viewModules').innerText = modules;
        document.getElementById('viewAmount').innerText = "‚Ç± " + parseFloat(amount).toLocaleString();
        document.getElementById('viewRequestedBy').innerText = requestedBy;
        document.getElementById('viewDue').innerText = due;
        document.getElementById('viewStatus').innerText = status;
        document.getElementById('viewPurpuse').innerText = purpuse;
        document.getElementById('viewModal').classList.remove('hidden');
    }

    function openUpdateModal(requestID, ApprovedAmount) {
        document.getElementById('updateRequestId').value = requestID;
        document.getElementById('updateAmount').value = ApprovedAmount;
        document.getElementById('updateModal').classList.remove('hidden');
    }

    function openRejectModal(requestID) {
        document.getElementById('rejectRequestId').value = requestID;
        document.getElementById('rejectRemarks').value = '';
        document.getElementById('rejectModal').classList.remove('hidden');
    }

    function openApproveModal(requestID, approvedAmount) {
        document.getElementById('approveRequestId').value = requestID;
        document.getElementById('confirmAmount').innerText = '‚Ç±' + approvedAmount.toLocaleString();
        document.getElementById('approveModal').classList.remove('hidden');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
    }

    function outsideClick(event, modalId) {
        if (event.target.id === modalId) {
            closeModal(modalId);
        }
    }

    let requests = <?php echo json_encode($requests); ?>;
    let disbursementReports = <?php echo json_encode($disbursementReports); ?>;

    
    const container = document.getElementById("approvalCards");
    const tableBody = document.getElementById("employeesTableBody");
    const modal = document.getElementById("detailsModal");
    const modalContent = document.getElementById("modalContent");
    const modalButtons = document.getElementById("modalButtons");

    function buildCards() {
        container.innerHTML = '';
        if (requests.length === 0) {
            container.innerHTML = `
                <div class="col-span-full text-center py-10">
                    <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
                    <h4 class="text-lg font-medium text-gray-500">All caught up!</h4>
                    <p class="text-gray-400">There are no new requests for your approval at the moment. Good job!</p>
                </div>
            `;
            return;
        }
        requests.forEach(req => {
            let cardColor = "from-gray-50 to-white border-gray-200 text-gray-600";
            let icon = "fa-file-alt";

            switch (req.Name.toLowerCase()) {
                case "hr":
                    cardColor = "from-purple-50 to-white border-purple-200 text-purple-600";
                    icon = "fa-users";
                    break;
                case "maintenance":
                case "operations":
                    cardColor = "from-green-50 to-white border-green-200 text-green-600";
                    icon = "fa-truck";
                    break;
                case "finance":
                    cardColor = "from-blue-50 to-white border-blue-200 text-blue-600";
                    icon = "fa-briefcase";
                    break;
                case "general services":
                    cardColor = "from-red-50 to-white border-red-200 text-red-600";
                    icon = "fa-gas-pump";
                    break;
                default:
                    cardColor = "from-indigo-50 to-white border-indigo-200 text-indigo-600";
                    icon = "fa-layer-group";
            }
 
            let buttonHTML = "";
            let balanceDisplay = `<p><span class="font-medium">Available Balance:</span> ‚Ç±${Number(req.balance).toLocaleString()}</p>`;
            let inputMax = req.balance > 0 ? req.balance : 0;
            let inputDisabled = req.balance <= 0 ? 'disabled' : '';
            let approveDisabled = req.balance <= 0 ? 'disabled' : '';

            if (req.status === "Pending") {
                buttonHTML = `
                <div class="mt-4 space-y-3">
                    <label class="block text-sm ">Change Amount</label>
                    <input id="approvedAmount-${req.requestID}" 
                           type="number" 
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400 focus:outline-none"
                           placeholder="Enter approved amount"
                           value="${req.Amount}"
                           max="${inputMax}"
                           ${inputDisabled}
                           step="0.01"
                           min="0">

                    ${balanceDisplay}

                    <div class="flex gap-2">
                        <button class="flex-1 bg-indigo-500 text-white text-sm font-semibold py-2 rounded-md hover:bg-indigo-600 transition ${approveDisabled}"
                                onclick="initiateApprove(${req.requestID})">Approve</button>
                        <button class="flex-1 bg-red-500 text-white text-sm font-semibold py-2 rounded-md hover:bg-red-600 transition"
                                onclick="reject(${req.requestID})">Reject</button>
                    </div>
                </div>
                `;
            }

            container.innerHTML += `
                      <div class=" ${cardColor} rounded-xl shadow-lg p-6 hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 border border-opacity-50" data-id="${req.requestID}" role="article" aria-labelledby="card-title-${req.requestID}">
                    <div class="flex items-center justify-between mb-4">
                        <i class="fas ${icon} text-3xl ${cardColor.split(' ')[2].replace('border-', 'text-')}"></i>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${req.status === 'Approved' ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}">
                            ${req.status}
                        </span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2 capitalize" id="card-title-${req.requestID}">${req.Name} Department</h3>
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 capitalize">${req.Title}</h4>
                    <div class="text-sm text-gray-600 space-y-2">
                        <p><span class="font-medium text-gray-700">ID:</span> REQ-${req.requestID}</p>
                        <p><span class="font-medium text-gray-700">Title:</span> ${req.requestTiTle}</p>
                            <p><span class="font-medium">Requested Amount:</span> ‚Ç±${Number(req.Amount).toLocaleString()}</p>
                            <p><span class="font-medium">Requested By:</span> ${req.Requested_by}</p>
                 
                        </div>
                
                    <div class="mt-4">
                        ${buttonHTML}
                        <button class="text-indigo-600 text-sm mt-2 hover:underline" onclick="viewDetails(${req.requestID})">View Details</button>
                    </div>
                </div>
            `;
        });
    }

    function buildTable() {
        const tbody = document.getElementById('employeesTableBody');
        if (!tbody) return;

        if (disbursementReports.length === 0) {
            tbody.innerHTML = '<tr><td colspan="11" class="text-center p-4">NO Records Found.</td></tr>';
            return;
        }

        let html = '';
        disbursementReports.forEach(row => {
            const status = row.status.toLowerCase().trim();
            let statusClass = "status-default";
            switch (status) {
                case "paid":
                    statusClass = "status-paid";
                    break;
                case "approved":
                    statusClass = "status-approved";
                    break;
                case "reject":
                case "rejected":
                    statusClass = "status-reject";
                    break;
                case "pending":
                    statusClass = "status-verified";
                    break;
            }

            const amount = row.Amount ? Number(row.Amount).toLocaleString('en-PH', {minimumFractionDigits: 0, maximumFractionDigits: 0}) : '0';
            const approvedAmount = row.ApprovedAmount ? Number(row.ApprovedAmount).toLocaleString('en-PH', {minimumFractionDigits: 0, maximumFractionDigits: 0}) : '0';
            const dueDate = row.Due ? new Date(row.Due).toLocaleDateString('en-US', {month: 'long', day: 'numeric', year: 'numeric'}) : '-';
            const requestDate = row.date ? new Date(row.date).toLocaleString('en-US', {month: 'long', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true}) : '-';

            let updateLink = '';
            if (status !== 'paid' && status !== 'released' && status !== 'rejected') {
                updateLink = `<a href="#" onclick="openUpdateModal('${row.requestID}', '${row.ApprovedAmount}'); return false;">‚úèÔ∏è Update</a>`;
            }

            html += `
                <tr>
                    <td>${row.requestID}</td>
                    <td>${row.requestTiTle}</td>
                    <td>${row.Title}</td>
                    <td>‚Ç± ${amount}</td>
                    <td>‚Ç± ${approvedAmount}</td>
                    <td>${row.Requested_by}</td>
                    <td>${dueDate}</td>
                    <td>${row.Purpuse || ''}</td>
                    <td><span class="status-badge ${statusClass}">${row.status}</span></td>
                    <td>${requestDate}</td>
                    <td>
                        <a href="#" onclick="openViewModal('${row.requestID}', '${row.requestTiTle.replace(/'/g, "\\'")}', '${row.Title.replace(/'/g, "\\'")}', '${row.Amount}', '${row.Requested_by.replace(/'/g, "\\'")}', '${row.Due}', '${row.status}', '${(row.Purpuse || '').replace(/'/g, "\\'")}'); return false;">üëÅÔ∏è View</a>
                        ${updateLink}
                    </td>
                </tr>
            `;
        });
        tbody.innerHTML = html;
    }

    function fetchRequests() {
        const url = window.location.pathname + '?json=1';
        fetch(url)
            .then(res => res.json())
            .then(data => {
                requests = data;
                buildCards();
            })
            .catch(err => console.error('Fetch error', err));
    }

    function fetchReports() {
        const url = window.location.pathname + '?json_reports=1';
        fetch(url)
            .then(res => res.json())
            .then(data => {
                disbursementReports = data;
                buildTable();
            })
            .catch(err => console.error('Fetch reports error', err));
    }


    buildCards();
    buildTable();

  
    setInterval(() => {
        fetchRequests();
        fetchReports();
    }, 5000);

    function initiateApprove(id) {
        const input = document.getElementById(`approvedAmount-${id}`);
        if (!input || !input.value) {
            window.location.href = window.location.pathname + '?error=1&message=Please enter the approved amount.';
            return;
        }

        const approvedAmount = parseFloat(input.value);
        if (isNaN(approvedAmount) || approvedAmount <= 0) {
            window.location.href = window.location.pathname + '?error=1&message=Please enter a valid amount.';
            return;
        }

        const req = requests.find(r => Number(r.requestID) === Number(id));
        if (req && approvedAmount > req.balance) {
            window.location.href = window.location.pathname + '?error=1&message=Approved amount exceeds available balance of ‚Ç±' + Number(req.balance).toLocaleString() + '.';
            return;
        }

        openApproveModal(id, approvedAmount);
    }

    document.getElementById('approveConfirmBtn').addEventListener('click', function() {
        const id = document.getElementById('approveRequestId').value;
        const input = document.getElementById(`approvedAmount-${id}`);
        const approvedAmount = parseFloat(input.value);

        fetch('../../crud/budget/planning.php', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ requestID: id, status: "Approved", approvedAmount })
        })
        .then(res => res.json())
        .then(data => {
            closeModal('approveModal');
            if (data.success) {
                window.location.href = window.location.pathname + '?success=1&message=Request Approved!';
            } else {
                window.location.href = window.location.pathname + '?error=1&message=' + encodeURIComponent(data.message || "Failed to update request.");
            }
        })
        .catch(err => {
            console.error(err);
            closeModal('approveModal');
            window.location.href = window.location.pathname + '?error=1&message=An error occurred';
        });
    });
    
    document.getElementById('rejectBtn').addEventListener('click', function() {
        const id = document.getElementById('rejectRequestId').value;
        const remarks = document.getElementById('rejectRemarks').value.trim();

        fetch('../../crud/budget/planning.php', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ requestID: id, status: "Rejected", remarks: remarks || undefined })
        })
        .then(res => res.json())
        .then(data => {
            closeModal('rejectModal');
            if (data.success) {
                window.location.href = window.location.pathname + '?success=1&message=Request Rejected!';
            } else {
                window.location.href = window.location.pathname + '?error=1&message=' + encodeURIComponent(data.message || "Failed to update request.");
            }
        })
        .catch(err => {
            console.error(err);
            window.location.href = window.location.pathname + '?error=1&message=An error occurred';
        });
    });

    function reject(id) {
        openRejectModal(id);
    }

 
    function viewDetails(id) {
        const req = requests.find(r => Number(r.requestID) === Number(id));
        if (!req) return;

        modalContent.innerHTML = `
          <p><span class="font-medium">ID:</span> REQ-${req.requestID}</p>
            <p><span class="font-medium">Title:</span> ${req.requestTiTle}</p>
            <p><span class="font-medium">Cost Allocation:</span> ${req.Title}</p>
            <p><span class="font-medium">Department:</span> ${req.Name}</p>
            <p><span class="font-medium">Requested Amount:</span> ‚Ç±${Number(req.Amount).toLocaleString()}</p>
            <p><span class="font-medium">Available Balance:</span> ‚Ç±${Number(req.balance).toLocaleString()}</p>
            <p><span class="font-medium">Requested By:</span> ${req.Requested_by}</p>
            <p><span class="font-medium">Due:</span> ${req.Due}</p>
            <p><span class="font-medium">Status:</span> ${req.status}</p>
            <p><span class="font-medium">Date:</span> ${req.date}</p>
        `;

        modalButtons.innerHTML = `
            <button onclick="closeModals()" 
                    class="px-4 py-2 rounded-md border border-gray-300 text-gray-600 hover:bg-gray-100">Close</button>
        `;

        modal.classList.remove("hidden");
    }

    function closeModals() {
        modal.classList.add("hidden");
    }
</script>