<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Department Budget Allocation</title>
</head>
<body class="bg-gradient-to-r from-indigo-50 to-purple-50 min-h-screen flex items-center justify-center p-6">

  <div class="w-full max-w-6xl bg-white rounded-2xl shadow-2xl p-8 border border-gray-200">
    <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-indigo-600" viewBox="0 0 20 20" fill="currentColor">
        <path d="M11 17a1 1 0 102 0v-2a1 1 0 10-2 0v2zM9 13a1 1 0 102 0V9a1 1 0 10-2 0v4zM7 9a1 1 0 102 0V5a1 1 0 10-2 0v4zM5 5a1 1 0 102 0V3a1 1 0 10-2 0v2z"/>
      </svg>
      Department Budget Allocation
    </h2>

    <!-- Department & Year Select -->
    <div class="flex gap-6 mb-6">
      <!-- Department -->
      <div>
        <label class="block text-gray-600 mb-2 font-medium">Select Department</label>
        <select id="department-select" onchange="loadAvailableYears()" class="w-72 border rounded-lg p-3 text-gray-700 focus:ring focus:ring-indigo-300">
          <option value="">-- Select Department --</option>
          <option value="Finance">Finance</option>
          <option value="Operations">Operations</option>
          <option value="HR">HR</option>
          <option value="Admin">Admin</option>
          <option value="General Services">General Services</option>
        </select>
      </div>

      <!-- Year -->
      <div>
        <label class="block text-gray-600 mb-2 font-medium">Select Year</label>
        <select id="year-select" onchange="loadDepartmentBudget()" class="w-40 border rounded-lg p-3 text-gray-700 focus:ring focus:ring-indigo-300">
          <option value="">-- Select Year --</option>
        </select>
      </div>
    </div>

    <!-- Department Budget Display -->
    <div id="department-budget-box" class="hidden mb-6 bg-indigo-50 border border-indigo-200 p-4 rounded-lg shadow-sm">
      <p class="text-gray-700 text-lg font-medium">
        Yearly Budget for <span id="dept-name" class="font-bold text-indigo-700"></span>:
        <span id="dept-budget" class="font-bold text-indigo-600">₱0</span>
      </p>
    </div>

    <!-- Progress Indicator -->
    <div class="mb-6 hidden" id="progress-box">
      <div class="flex justify-between text-sm text-gray-600 mb-1">
        <span>Allocated %</span>
        <span id="percent-total">0%</span>
      </div>
      <div class="w-full bg-gray-200 h-3 rounded-full overflow-hidden">
        <div id="percent-bar" class="h-3 bg-green-500 w-0 transition-all"></div>
      </div>
    </div>

    <!-- Children Container -->
    <div id="child-rows" class="space-y-4 mb-6 hidden">
      <!-- First child row -->
      <div class="grid grid-cols-12 gap-4 items-center bg-gray-50 p-4 rounded-xl shadow-sm border border-gray-200 child-row">
        
        <!-- Title -->
        <div class="col-span-3">
          <input type="text" placeholder="Title" class="w-full border rounded-lg p-2 focus:ring focus:ring-indigo-200">
        </div>

        <!-- Percentage -->
        <div class="col-span-2">
          <input type="number" placeholder="%" class="w-full border rounded-lg p-2 percentage-input focus:ring focus:ring-indigo-200">
        </div>

        <!-- Yearly Amount (auto-calculated) -->
        <div class="col-span-3">
          <input type="number" placeholder="Yearly Amount" class="w-full border rounded-lg p-2 amount-input bg-gray-100" readonly>
        </div>

        <!-- Calculated -->
        <div class="col-span-2 text-center">
          <p class="text-sm text-gray-500">Daily: <span class="daily text-indigo-600 font-bold">₱0</span></p>
          <p class="text-sm text-gray-500">Monthly: <span class="monthly text-indigo-600 font-bold">₱0</span></p>
        </div>

        <!-- Buttons -->
        <div class="col-span-2 flex gap-2 justify-center">
          <button onclick="addChildRow(this)" class="w-10 h-10 rounded-full bg-green-500 hover:bg-green-600 text-white font-bold text-xl shadow-md">+</button>
          <button onclick="removeChildRow(this)" class="w-10 h-10 rounded-full bg-red-500 hover:bg-red-600 text-white font-bold text-xl shadow-md">−</button>
        </div>
      </div>
    </div>

    <!-- Submit Button -->
    <div class="flex justify-end hidden" id="submit-box">
      <button onclick="submitAllocation()" 
        class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-md transition">
        Submit Allocation
      </button>
    </div>
  </div>

  <script>
    // Department budgets per year
    const deptBudgets = {
      "Finance": { 2024: 1000000, 2025: 1200000 },
      "Operations": { 2025: 800000 },
      "HR": { 2024: 400000, 2025: 500000 },
      "Admin": { 2025: 300000 },
      "General Services": { 2024: 150000, 2025: 200000 }
    };

    // Populate available years when department changes
    function loadAvailableYears() {
      const dept = document.getElementById('department-select').value;
      const yearSelect = document.getElementById('year-select');
      yearSelect.innerHTML = "<option value=''>-- Select Year --</option>";

      if (dept && deptBudgets[dept]) {
        Object.keys(deptBudgets[dept]).forEach(year => {
          const opt = document.createElement("option");
          opt.value = year;
          opt.textContent = year;
          yearSelect.appendChild(opt);
        });
      }

      // Reset display until year chosen
      document.getElementById('department-budget-box').classList.add("hidden");
      document.getElementById('progress-box').classList.add("hidden");
      document.getElementById('child-rows').classList.add("hidden");
      document.getElementById('submit-box').classList.add("hidden");
    }

    // Load budget when both dept & year are selected
    function loadDepartmentBudget() {
      const dept = document.getElementById('department-select').value;
      const year = document.getElementById('year-select').value;

      const budgetBox = document.getElementById('department-budget-box');
      const progressBox = document.getElementById('progress-box');
      const childRows = document.getElementById('child-rows');
      const submitBox = document.getElementById('submit-box');

      if (dept && year && deptBudgets[dept] && deptBudgets[dept][year]) {
        document.getElementById('dept-name').textContent = dept + " (" + year + ")";
        document.getElementById('dept-budget').textContent = "₱" + deptBudgets[dept][year].toLocaleString();
        budgetBox.classList.remove("hidden");
        progressBox.classList.remove("hidden");
        childRows.classList.remove("hidden");
        submitBox.classList.remove("hidden");

        updateAllRows();
      } else {
        budgetBox.classList.add("hidden");
        progressBox.classList.add("hidden");
        childRows.classList.add("hidden");
        submitBox.classList.add("hidden");
      }
    }

    // Update calculations based on % input
    function calculate(row) {
      const dept = document.getElementById('department-select').value;
      const year = document.getElementById('year-select').value;
      const yearlyBudget = (deptBudgets[dept] && deptBudgets[dept][year]) || 0;

      const percentInput = row.querySelector('.percentage-input');
      const amountInput = row.querySelector('.amount-input');
      const dailySpan = row.querySelector('.daily');
      const monthlySpan = row.querySelector('.monthly');

      let percent = parseFloat(percentInput.value) || 0;
      let yearly = (yearlyBudget * percent) / 100;

      amountInput.value = yearly.toFixed(2);
      dailySpan.textContent = "₱" + (yearly / 365).toFixed(2);
      monthlySpan.textContent = "₱" + (yearly / 12).toFixed(2);

      updatePercentageTotal();
    }

    // Update all rows (when switching department or year)
    function updateAllRows() {
      document.querySelectorAll('.child-row').forEach(row => calculate(row));
    }

    // Add new child row
    function addChildRow(button) {
      const container = document.getElementById('child-rows');
      const row = button.closest('.child-row');
      const newRow = row.cloneNode(true);

      // Reset inputs
      newRow.querySelectorAll('input').forEach(input => input.value = "");
      newRow.querySelector('.daily').textContent = "₱0";
      newRow.querySelector('.monthly').textContent = "₱0";

      // Attach calculation event
      attachEvents(newRow);

      container.appendChild(newRow);
    }

    // Remove child row
    function removeChildRow(button) {
      const container = document.getElementById('child-rows');
      if (container.querySelectorAll('.child-row').length > 1) {
        button.closest('.child-row').remove();
        updatePercentageTotal();
      } else {
        alert("At least one row must remain.");
      }
    }

    // Attach live calculation to % input
    function attachEvents(row) {
      row.querySelector('.percentage-input').addEventListener('input', () => calculate(row));
    }

    // Initial attach
    document.querySelectorAll('.child-row').forEach(row => attachEvents(row));

    // Update total percentage bar
    function updatePercentageTotal() {
      const percentages = document.querySelectorAll('.percentage-input');
      let total = 0;
      percentages.forEach(input => {
        total += parseFloat(input.value) || 0;
      });

      const percentBar = document.getElementById('percent-bar');
      const percentText = document.getElementById('percent-total');

      percentText.textContent = total + "%";
      percentBar.style.width = Math.min(total, 100) + "%";

      if (total > 100) {
        percentBar.classList.remove("bg-green-500");
        percentBar.classList.add("bg-red-500");
      } else {
        percentBar.classList.remove("bg-red-500");
        percentBar.classList.add("bg-green-500");
      }

      return total;
    }

    // Submit handler
    function submitAllocation() {
      let total = updatePercentageTotal();
      if (total > 100) {
        alert("⚠️ Allocation exceeds 100%! Please adjust percentages.");
        return;
      }

      const department = document.getElementById('department-select').value;
      const year = document.getElementById('year-select').value;
      const rows = document.querySelectorAll('.child-row');
      let allocations = [];

      rows.forEach(row => {
        allocations.push({
          title: row.querySelector('input[type="text"]').value,
          percentage: row.querySelector('.percentage-input').value,
          yearly: row.querySelector('.amount-input').value,
          daily: row.querySelector('.daily').textContent,
          monthly: row.querySelector('.monthly').textContent,
        });
      });

      console.log({
        department,
        year,
        yearlyBudget: deptBudgets[department][year],
        allocations
      });

      alert("✅ Allocation submitted! Check console for details.");
    }
  </script>

</body>
</html>
